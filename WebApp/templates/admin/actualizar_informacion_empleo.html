{% extends 'base.html' %}
{% load form_filters %}

{% block title %}Editar Información de Empleo{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card p-4">
        <h2 class="card-title">Editar Información de Empleo</h2>
        <form method="POST">
            {% csrf_token %}

            <!-- Campo Departamento -->
            <div class="form-group mt-3">
                <label for="id_departamento">Departamento:</label>
                {{ form.departamento|add_class:"form-control" }}
            </div>

            <!-- Campo Área -->
            <div class="form-group mt-3">
                <label for="id_area">Área:</label>
                {{ form.area|add_class:"form-control" }}
            </div>

            <!-- Campo Cargo -->
            <div class="form-group mt-3">
                <label for="id_cargo">Cargo:</label>
                {{ form.cargo|add_class:"form-control" }}
            </div>

            <!-- Botones -->
            <div class="d-flex justify-content-between mt-3">
                <button type="submit" class="btn btn-success">Guardar Cambios</button>
                <a href="{% url 'ver_trabajador' trabajador.id %}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const departamentosData = {{ departamentos_json|safe }};
        const areasData = {{ areas_json|safe }};
        const cargosData = {{ cargos_json|safe }};

        const departamentoSelect = document.getElementById("id_departamento");
        const areaSelect = document.getElementById("id_area");
        const cargoSelect = document.getElementById("id_cargo");

        // Pre-select current area and cargo based on trabajador
        const selectedDepartamento = {{ trabajador.departamento_id|default:"null" }};
        const selectedArea = {{ trabajador.area_id|default:"null" }};
        const selectedCargo = {{ trabajador.cargo_id|default:"null" }};

        function populateOptions(select, options, selectedOption = null) {
            select.innerHTML = '';
            options.forEach(option => {
                const opt = document.createElement("option");
                opt.value = option.id;
                opt.textContent = option.nombre;
                if (selectedOption && selectedOption === option.id) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });
        }

        departamentoSelect.addEventListener("change", function () {
            const departamentoId = parseInt(this.value);
            const filteredAreas = areasData.filter(area => area.departamento_id === departamentoId);
            populateOptions(areaSelect, filteredAreas);

            areaSelect.disabled = filteredAreas.length === 0;
            cargoSelect.disabled = true;
            cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
        });

        areaSelect.addEventListener("change", function () {
            const areaId = parseInt(this.value);
            const filteredCargos = cargosData.filter(cargo => cargo.area_id === areaId);
            populateOptions(cargoSelect, filteredCargos);

            cargoSelect.disabled = filteredCargos.length === 0;
        });

        // Initialize with current values
        if (selectedDepartamento) {
            departamentoSelect.value = selectedDepartamento;
            const filteredAreas = areasData.filter(area => area.departamento_id === selectedDepartamento);
            populateOptions(areaSelect, filteredAreas, selectedArea);
            areaSelect.disabled = filteredAreas.length === 0;
        }

        if (selectedArea) {
            const filteredCargos = cargosData.filter(cargo => cargo.area_id === selectedArea);
            populateOptions(cargoSelect, filteredCargos, selectedCargo);
            cargoSelect.disabled = filteredCargos.length === 0;
        }
    });
</script>
{% endblock %}
