{% extends 'base.html' %}

{% block title %}Actualizar Trabajador{% endblock %}

{% block content %}
<div class="container mt-2">
    <h2 class="text-center mb-4">Actualizar Información del Trabajador</h2>
    <div class="card p-4">
        <form method="POST">
            {% csrf_token %}
            <!-- Formulario de Información Básica -->
            <div class="row">
                <h5>Información Básica</h5>
                <div class="col-md-6 mb-3">
                    <label for="first_name">Nombre:</label>
                    {{ form_info.first_name }}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="last_name">Apellido:</label>
                    {{ form_info.last_name }}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="email">Correo Electrónico:</label>
                    {{ form_info.email }}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="sexo">Sexo:</label>
                    {{ form_info.sexo }}
                </div>
            </div>
        
           <!-- Formulario de Información del trabajador -->
            <div class="row mt-4">
                <h5>Información del Trabajador</h5>
                
                <div class="col-md-6 mb-3">
                    <label for="fecha_ingreso">Fecha de Ingreso:</label>
                    {{ form_detalles.fecha_ingreso }}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="departamento">Departamento:</label>
                    {{ form_detalles.departamento }}
                </div>
                
                <!-- Mostrar área y cargo solo si hay errores o si el departamento está seleccionado -->
                <div class="col-md-6 mb-3" id="area-container" style="display: {% if form_detalles.area.errors or form_detalles.departamento.value %} block {% else %} none {% endif %};">
                    <label for="area">Área:</label>
                    {{ form_detalles.area }}
                </div>
        
                <div class="col-md-6 mb-3" id="cargo-container" style="display: {% if form_detalles.cargo.errors or form_detalles.area.value %} block {% else %} none {% endif %};">
                    <label for="cargo">Cargo:</label>
                    {{ form_detalles.cargo }}
                </div>
            </div>
        
            <!-- Botón de Guardar Cambios -->
            <div class="d-flex justify-content-between mt-4">
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                <a href="{% url 'trabajadores' %}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        const departamentoSelect = $("#{{ form_detalles.departamento.id_for_label }}");
        const areaSelect = $("#{{ form_detalles.area.id_for_label }}");
        const cargoSelect = $("#{{ form_detalles.cargo.id_for_label }}");
    
        // Función para cargar las áreas
        function cargarAreas(departamentoId) {
            $.ajax({
                url: "{% url 'cargar_areas' %}",
                data: { 'departamento_id': departamentoId },
                success: function(data) {
                    areaSelect.empty().append('<option value="">Seleccione un área</option>');
                    cargoSelect.empty().append('<option value="">Seleccione un cargo</option>'); // Limpiar cargos
                    $('#area-container').show();  // Mostrar el contenedor de áreas
    
                    // Agregar áreas al select
                    data.forEach(function(area) {
                        areaSelect.append('<option value="' + area.id + '">' + area.nombre + '</option>');
                    });
                },
                error: function() {
                    console.error("Error al cargar las áreas");
                }
            });
        }
    
        // Función para cargar los cargos
        function cargarCargos(areaId) {
            $.ajax({
                url: "{% url 'cargar_cargos' %}",
                data: { 'area_id': areaId },
                success: function(data) {
                    cargoSelect.empty().append('<option value="">Seleccione un cargo</option>');
                    $('#cargo-container').show();  // Mostrar el contenedor de cargos
    
                    // Agregar cargos al select
                    data.forEach(function(cargo) {
                        cargoSelect.append('<option value="' + cargo.id + '">' + cargo.nombre + '</option>');
                    });
                },
                error: function() {
                    console.error("Error al cargar los cargos");
                }
            });
        }
    
        // Al cargar la página, si ya hay un departamento seleccionado, cargar las áreas
        const departamentoId = departamentoSelect.val();
        if (departamentoId) {
            cargarAreas(departamentoId);
    
            // Si ya hay un área seleccionada, cargar los cargos correspondientes
            const areaId = areaSelect.val();
            if (areaId) {
                cargarCargos(areaId);
            }
        }
    
        // Al cambiar el departamento, cargar las áreas correspondientes
        departamentoSelect.change(function() {
            const departamentoId = $(this).val();
            if (departamentoId) {
                cargarAreas(departamentoId);
            } else {
                $('#area-container').hide();
                $('#cargo-container').hide();
            }
        });
    
        // Al cambiar el área, cargar los cargos correspondientes
        areaSelect.change(function() {
            const areaId = $(this).val();
            if (areaId) {
                cargarCargos(areaId);
            } else {
                $('#cargo-container').hide();
            }
        });
    });    
</script>
{% endblock %}
